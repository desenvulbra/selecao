var app=angular.module("ulbra",["ngAnimate","ngMessages","ui.router","toastr","ui.utils.masks","ngMd5"]).run(["$rootScope","TokenManager","$state","toastr","$transitions",function(t,e,o,r,n){n.onBefore({},function(t){var n=t.$to().self.auth;return!e.isAuthenticated()&&n?(event.preventDefault(),r.error("Acesso negado.","Ops!"),o.go("home"),!1):!(e.isAuthenticated()&&!n)||(event.preventDefault(),r.error("Acesso negado.","Ops!"),o.go("cursos"),!1)})}]).config(["$stateProvider","$urlRouterProvider","$httpProvider","$locationProvider",function(t,e,o,r){e.otherwise("/"),r.html5Mode(!0),o.interceptors.push("AuthInterceptor"),t.state("home",{url:"/",templateUrl:"/views/home.html",controller:"HomeCtrl",controllerAs:"$ctrl",auth:!1}).state("cadastro",{url:"/cadastro",templateUrl:"/views/cadastro.html",controller:"CadastroCtrl",controllerAs:"$ctrl",auth:!1}).state("cursos",{url:"/cursos",templateUrl:"/views/cursos.html",controller:"CursosCtrl",controllerAs:"$ctrl",auth:!0})}]);app.controller("CadastroCtrl",["Auth","TokenManager","toastr","$state",function(t,e,o,r){var n=this;n.submitting=!1,n.errorMessage={},n.usuario={sexo:null},n.cadastrar=function(){n.submitting=!0,t.register(n.usuario).then(function(t){e.saveToken(t.data.token),o.success("Usuário autenticado com sucesso."),r.go("cursos")}).catch(function(t){n.submitting=!1,n.errorMessage={},angular.forEach(t.data,function(t,e){n.form[e].$setValidity("server",!1),n.errorMessage[e]=t})})}}]),app.controller("CursosCtrl",["Curso","toastr","TokenManager","$state","toastr",function(t,e,o,r,e){var n=this;n.cursos=[],t.obterCursos().then(function(t){n.cursos=t.data}).catch(function(){e.error("Falha ao carregar os cursos.")}),n.logout=function(){o.deleteToken(),e.success("Sessão encerrada com sucesso."),r.go("home")}}]),app.controller("HomeCtrl",["Auth","TokenManager","toastr","$state",function(t,e,o,r){var n=this;n.submitting=!1,n.login=function(){n.submitting=!0,t.authenticate(n.email,n.senha).then(function(t){e.saveToken(t.data.token),o.success("Usuário autenticado com sucesso."),r.go("cursos")}).catch(function(t){n.submitting=!1;var e=t.data.message;o.error(e)})},n.googleSignIn=function(n){t.googleSignIn(n).then(function(t){e.saveToken(t.data.token),o.success("Usuário autenticado com sucesso."),r.go("cursos")}).catch(function(t){o.error("Ocorreu um erro ao fazer login. Tente novamente.")})},n.handleError=function(){o.error("Ocorreu um erro ao fazer login. Tente novamente.")}}]),app.factory("Auth",["$http","md5",function(t,e){return{authenticate:function(o,r){return r=e.createHash(r),t.post("/api/auth/login",{email:o,senha:r})},googleSignIn:function(e){return t.post("/api/auth/google-signin",{token:e})},register:function(o){return!(!o||!o.senha)&&(o=angular.copy(o,{}),o.senha=e.createHash(o.senha),t.post("/api/auth/register",o))}}}]),app.factory("AuthInterceptor",["TokenManager",function(t){return{request:function(e){var o=t.getToken();return o&&(e.headers.Authorization=o),e}}}]),app.factory("Curso",["$http",function(t){return{obterCursos:function(){return t.get("/api/cursos")}}}]),app.factory("TokenManager",["$window",function(t){return{isAuthenticated:function(){var t=this.getToken();if(t){var e=this.parseToken(t);return Math.round((new Date).getTime()/1e3)<=e.exp}return!1},parseToken:function(e){var o=e.split(".")[1].replace("-","+").replace("_","/");return JSON.parse(t.atob(o))},saveToken:function(e){t.localStorage.jwtToken=e},getToken:function(){return t.localStorage.jwtToken},deleteToken:function(){t.localStorage.removeItem("jwtToken")}}}]),app.directive("compareTo",function(){return{require:"ngModel",scope:{otherModelValue:"=compareTo"},link:function(t,e,o,r){r.$validators.compareTo=function(e){return e==t.otherModelValue},t.$watch("otherModelValue",function(){r.$validate()})}}}),app.directive("googleSignin",["$window","$parse",function(t,e){return{link:function(o,r,n,a){function s(){auth2.attachClickHandler(r[0],{},function(t){e(n.googleSignin)(o,{token:t.getAuthResponse().id_token})},function(t){e(n.onError)(o,{error:t})})}t.gapi.load("auth2",function(){auth2=gapi.auth2.init({client_id:"1084687228436-ledm4qf98qajvpm5rcdlrior7p4ujde1.apps.googleusercontent.com",cookiepolicy:"single_host_origin"}),s()})}}}]),app.directive("serverError",[function(){return{restrict:"A",require:["ngModel","^form"],link:function(t,e,o,r){var n=r[0],a=r[1];t.$watch(function(){return n.$modelValue},function(){a[o.name].$setValidity("server",!0)})}}}]),app.directive("validPassword",function(){return{require:"ngModel",link:function(t,e,o,r){r.$validators.validPassword=function(t){if(!t||t.length<8)return!1;var e=/[A-Z]/;return!!e.test(t)&&(!!(e=/[0-9]/).test(t)&&(e=/[^\w\s]/).test(t))}}}});