var app=angular.module("ulbra",["ngAnimate","ngMessages","ui.router","toastr","ui.utils.masks","ngMd5"]).run(["$rootScope","TokenManager","$state","toastr","$transitions",function(t,e,r,o,n){n.onBefore({},function(t){var n=t.$to().self.auth;return!e.isAuthenticated()&&n?(event.preventDefault(),o.error("Acesso negado.","Ops!"),r.go("home"),!1):!(e.isAuthenticated()&&!n)||(event.preventDefault(),o.error("Acesso negado.","Ops!"),r.go("cursos"),!1)})}]).config(["$stateProvider","$urlRouterProvider","$httpProvider",function(t,e,r){e.otherwise("/"),r.interceptors.push("AuthInterceptor"),t.state("home",{url:"/",templateUrl:"/views/home.html",controller:"HomeCtrl",controllerAs:"$ctrl",auth:!1}).state("cadastro",{url:"/cadastro",templateUrl:"/views/cadastro.html",controller:"CadastroCtrl",controllerAs:"$ctrl",auth:!1}).state("cursos",{url:"/cursos",templateUrl:"/views/cursos.html",controller:"CursosCtrl",controllerAs:"$ctrl",auth:!0})}]);app.controller("CadastroCtrl",["Auth","TokenManager","toastr","$state",function(t,e,r,o){var n=this;n.submitting=!1,n.errorMessage={},n.usuario={sexo:null},n.cadastrar=function(){n.submitting=!0,t.register(n.usuario).then(function(t){e.saveToken(t.data.token),r.success("Usuário autenticado com sucesso."),o.go("cursos")}).catch(function(t){n.submitting=!1,n.errorMessage={},angular.forEach(t.data,function(t,e){n.form[e].$setValidity("server",!1),n.errorMessage[e]=t})})}}]),app.controller("CursosCtrl",["Curso","toastr","TokenManager","$state","toastr",function(t,e,r,o,e){var n=this;n.cursos=[],t.obterCursos().then(function(t){n.cursos=t.data}).catch(function(){e.error("Falha ao carregar os cursos.")}),n.logout=function(){r.deleteToken(),e.success("Sessão encerrada com sucesso."),o.go("home")}}]),app.controller("HomeCtrl",["Auth","TokenManager","toastr","$state",function(t,e,r,o){var n=this;n.submitting=!1,n.login=function(){n.submitting=!0,t.authenticate(n.email,n.senha).then(function(t){e.saveToken(t.data.token),r.success("Usuário autenticado com sucesso."),o.go("cursos")}).catch(function(t){n.submitting=!1;var e=t.data.message;r.error(e)})},n.googleSignIn=function(){}}]),app.directive("compareTo",function(){return{require:"ngModel",scope:{otherModelValue:"=compareTo"},link:function(t,e,r,o){o.$validators.compareTo=function(e){return e==t.otherModelValue},t.$watch("otherModelValue",function(){o.$validate()})}}}),app.directive("serverError",[function(){return{restrict:"A",require:["ngModel","^form"],link:function(t,e,r,o){var n=o[0],a=o[1];t.$watch(function(){return n.$modelValue},function(){a[r.name].$setValidity("server",!0)})}}}]),app.directive("validPassword",function(){return{require:"ngModel",link:function(t,e,r,o){o.$validators.validPassword=function(t){if(!t||t.length<8)return!1;var e=/[A-Z]/;return!!e.test(t)&&(!!(e=/[0-9]/).test(t)&&(e=/[^\w\s]/).test(t))}}}}),app.factory("Auth",["$http","md5",function(t,e){return{authenticate:function(r,o){return o=e.createHash(o),t.post("/auth/login",{email:r,senha:o})},register:function(r){return!(!r||!r.senha)&&(r=angular.copy(r,{}),r.senha=e.createHash(r.senha),t.post("/auth/register",r))}}}]),app.factory("AuthInterceptor",["TokenManager",function(t){return{request:function(e){var r=t.getToken();return r&&(e.headers.Authorization=r),e}}}]),app.factory("Curso",["$http",function(t){return{obterCursos:function(){return t.get("/cursos")}}}]),app.factory("TokenManager",["$window",function(t){return{isAuthenticated:function(){var t=this.getToken();if(t){var e=this.parseToken(t);return Math.round((new Date).getTime()/1e3)<=e.exp}return!1},parseToken:function(e){var r=e.split(".")[1].replace("-","+").replace("_","/");return JSON.parse(t.atob(r))},saveToken:function(e){t.localStorage.jwtToken=e},getToken:function(){return t.localStorage.jwtToken},deleteToken:function(){t.localStorage.removeItem("jwtToken")}}}]);